{"version":3,"sources":["../../src/server/controllers/user-controller.js"],"names":["load","req","res","next","id","get","then","user","catch","e","json","create","role","body","email","password","getByEmail","existingUser","err","UNAUTHORIZED","save","savedUser","roles","Professional","Admin","list","query","name","org","length","createProfessional","Client","status","client","savedClient","authToken","createToken","organization","_id","professional","savedProfessional","update","limit","skip","users","remove","console","log","deletedUser"],"mappings":"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","file":"user-controller.js","sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport {User, Professional} from '../models';\r\nimport AuthCtrl from './auth-controller';\r\nimport OrganizationCtrl from './organization-controller';\r\nimport APIError from '../lib/APIError';\r\nimport httpStatus from 'http-status';\r\nimport config from '../config';\r\nimport constants from '../lib/constants';\r\n\r\n/**\r\n* Load user and append to req.\r\n*/\r\nfunction load(req, res, next, id) {\r\n    User.get(id)\r\n    .then((user) => {\r\n        req.user = user;\r\n        return next();\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Get user\r\n* @returns {User}\r\n*/\r\nfunction get(req, res) {\r\n    return res.json(req.user);\r\n}\r\n\r\n/**\r\n* Create new user\r\n* @returns {User}\r\n*/\r\nfunction create(req, res, next) {\r\n    const user = new User({\r\n        role: req.body.role,\r\n        email: req.body.email,\r\n        password: req.body.password\r\n    });\r\n\r\n    //check if user already exists\r\n    return User.getByEmail(user.email)\r\n    .then(existingUser=>{\r\n        if(existingUser)\r\n        {\r\n            const err = new APIError('Authentication error: User Already Exists', httpStatus.UNAUTHORIZED, true);\r\n            return next(err);\r\n        } else {\r\n            user.save()\r\n            .then(savedUser => {\r\n                if(savedUser.role == constants.roles.Professional || savedUser.role == constants.roles.Admin){\r\n                    //get organization if it exists, otherwise create\r\n                    return OrganizationCtrl.list({query: {name: req.body.name}},res,next).then(org => {\r\n                        if(!org || org.length === 0){\r\n                            return OrganizationCtrl.create(req,res,next).then(org =>{\r\n                              return createProfessional(req,res,next,savedUser,org);  \r\n                            })        \r\n                        } \r\n                        return createProfessional(req,res,next,savedUser,org[0]);  \r\n                    })\r\n                }\r\n                else{\r\n                    //create the professional asynchronously\r\n                    return new Client({\r\n                        email: req.body.email,\r\n                        status: 1\r\n                    }).save().then(savedClient =>{\r\n                        savedUser.client = savedClient;\r\n                        savedUser.save();\r\n                        //log user in\r\n                        let authToken = AuthCtrl.createToken(savedUser);\r\n                        return res.json(authToken);\r\n                    });\r\n                    \r\n                }\r\n            })\r\n            .catch(e => next(e));\r\n        }\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\nfunction createProfessional(req,res,next, savedUser, organization){\r\n    return new Professional({\r\n        email: req.body.email,\r\n        organization: organization._id,\r\n        status: 1\r\n    }).save()\r\n    .then(savedProfessional =>{\r\n        savedUser.professional = savedProfessional;\r\n        savedUser.save();\r\n        //log user in\r\n        let authToken = AuthCtrl.createToken(savedUser);\r\n        return res.json(authToken);\r\n    })\r\n    .catch(e => next(e));\r\n\r\n}\r\n\r\n/**\r\n* Update existing user\r\n* @property {string} req.body.email - The email of user.\r\n* @returns {User}\r\n*/\r\nfunction update(req, res, next) {\r\n    const user = req.user;\r\n    user.email = req.body.email;\r\n\r\n    return user.save()\r\n    .then(savedUser => res.json(savedUser))\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Get user list.\r\n* @property {number} req.query.skip - Number of users to be skipped.\r\n* @property {number} req.query.limit - Limit number of users to be returned.\r\n* @returns {User[]}\r\n*/\r\nfunction list(req, res, next) {\r\n    const { limit = 50, skip = 0 } = req.query;\r\n    return User.list({ limit, skip })\r\n    .then(users => res.json(users))\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Delete user.\r\n* @returns {User}\r\n*/\r\nfunction remove(req, res, next) {\r\n    console.log('testt');        \r\n    const user = req.user;\r\n    return user.remove().then(deletedUser => {\r\n        return res.json(deletedUser)\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\nexport default { load, get, create, update, list, remove };\r\n"]}