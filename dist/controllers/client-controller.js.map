{"version":3,"sources":["../../src/server/controllers/client-controller.js"],"names":["load","req","res","next","userId","get","then","client","catch","e","json","getAppointments","find","_id","populate","sort","exec","appointments","create","getByEmail","body","email","existingClient","err","FORBIDDEN","firstname","lastname","birth","sex","insurance","organization","status","save","existingUser","length","savedClient","update","user","role","roles","Client","password","defaultPassword","list","query","limit","skip","queryObj","buildQuery","$or","createdAt","clients","Object","keys","array","key","obj","push","remove","deletedClient"],"mappings":"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","file":"client-controller.js","sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport {Client, Professional, User, Appointment} from '../models';\r\nimport APIError from '../lib/APIError';\r\nimport httpStatus from 'http-status';\r\nimport Constants from '../lib/constants';\r\n/**\r\n* Load client and append to req.\r\n*/\r\nfunction load(req, res, next, userId) {\r\n    Client.get(userId)\r\n    .then((client) => {\r\n        req.client = client;\r\n        return next();\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Get client\r\n* @returns {Client}\r\n*/\r\nfunction get(req, res) {\r\n    return res.json(req.client);\r\n}\r\n\r\n/**\r\n* Get client's Appointments\r\n* @returns {Appointment[]}\r\n*/\r\nfunction getAppointments(req, res, next) {\r\n    Appointment.find({client: req.client._id}) \r\n        .populate('client professional')\r\n        .sort('startDate')\r\n        .exec()\r\n        .then(appointments => res.json(appointments));\r\n}\r\n\r\n\r\n/**\r\n* Checks if user exists with same email as client.  If not, it creates a new User with the email provided and a default password. Then creates the Client to reside in the new user\r\n* @returns {Client}\r\n*/\r\nfunction create(req, res, next) {\r\n    Client.getByEmail(req.body.email).then(existingClient =>{\r\n        if(existingClient){\r\n            const err = new APIError('Error: Client Already Exists', httpStatus.FORBIDDEN, true);\r\n            return next(err);\r\n        }else{\r\n            const client = new Client({\r\n                firstname: req.body.firstname,\r\n                lastname: req.body.lastname,\r\n                email: req.body.email,\r\n                birth: req.body.birth,\r\n                sex: req.body.sex,\r\n                insurance: req.body.insurance,\r\n                organization: req.body.organization,\r\n                status: 1\r\n            }).save().then(savedClient =>{\r\n                //asynchronously add client to current professional -- doing this by organization now...\r\n                //Professional.findOneAndUpdate({email: req.locals.sessionUserEmail}, {$push:{clients:savedClient}}, (err,result) =>{});\r\n\r\n                //check if user already exists\r\n                User.getByEmail(req.body.email)\r\n                .then(existingUser=>{\r\n                    if(existingUser && existingUser.length > 0)\r\n                    {\r\n                        existingUser.client = savedClient._id;\r\n                        existingUser.update().then(savedUser => {\r\n                            return res.json(savedClient);\r\n                        });\r\n                    } else {\r\n                        //create new user.  Attach client\r\n                        const user = new User({\r\n                            role: Constants.roles.Client,\r\n                            email: req.body.email,\r\n                            password: Constants.defaultPassword,\r\n                            client: savedClient._id\r\n                        }).save().then(savedUser => {\r\n                            return res.json(savedClient);\r\n                        })\r\n                        .catch(e => next(e));\r\n                    }\r\n                })\r\n                .catch(e => next(e));\r\n            })\r\n            .catch(e => next(e));\r\n\r\n        }\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Update existing client\r\n* @property {string} req.body.email - The email of client.\r\n* @returns {Client}\r\n*/\r\nfunction update(req, res, next) {\r\n    //we may have to get user based off this.\r\n    const client = req.client;\r\n    client.email = req.body.email;\r\n    client.firstname = req.body.firstname;\r\n    client.lastname = req.body.lastname;\r\n    client.insurance = req.body.insurance;\r\n    client.sex = req.body.sex;\r\n    client.birth = req.body.birth;\r\n\r\n    client.save()\r\n    .then(savedClient => res.json(savedClient))\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Get client list.\r\n* @property {number} req.query.skip - Number of clients to be skipped.\r\n* @property {number} req.query.limit - Limit number of clients to be returned.\r\n* @returns {Client[]}\r\n*/\r\nfunction list(req, res, next) {\r\n    const { limit = 20, skip = 0 } = req.query;\r\n    delete req.query.limit;\r\n    delete req.query.skip;    \r\n    let queryObj = buildQuery(req);\r\n    \r\n    return Client.find(queryObj.length > 0 ? {$or: queryObj} : {})\r\n        .sort({ createdAt: -1 })\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .then(clients => res.json(clients))\r\n        .catch(e => next(e));\r\n}\r\n\r\nfunction buildQuery(req){\r\n    if (Object.keys(req.query).length === 0) return [];\r\n    var array = [];\r\n    for (var key in req.query) {\r\n        var obj = {};\r\n        obj[key] = req.query[key];\r\n        array.push(obj);\r\n    }\r\n    return array;\r\n}\r\n\r\n\r\n/**\r\n* Delete client.\r\n* @returns {Client}\r\n*/\r\nfunction remove(req, res, next) {\r\n    const client = req.client;\r\n    client.remove()\r\n    .then(deletedClient => res.json(deletedClient))\r\n    .catch(e => next(e));\r\n}\r\n\r\nexport default { load, get, create, update, list, remove, getAppointments };\r\n"]}