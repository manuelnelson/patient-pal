{"version":3,"sources":["../../src/server/controllers/client-controller.js"],"names":["load","req","res","next","userId","get","then","client","catch","e","getAppointments","find","_id","populate","sort","exec","appointments","create","exists","body","email","existingClient","err","FORBIDDEN","status","save","getByEmail","existingUser","length","savedClient","update","savedObj","toObject","savedUser","role","roles","Client","password","defaultPassword","prop","list","query","limit","skip","queryObj","buildQuery","$and","createdAt","clients","Object","keys","array","key","obj","push","remove","deletedClient"],"mappings":"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","file":"client-controller.js","sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport {Client, Professional, User, Appointment} from '../models';\r\nimport APIError from '../lib/APIError';\r\nimport httpStatus from 'http-status';\r\nimport Constants from '../lib/constants';\r\n/**\r\n* Load client and append to req.\r\n*/\r\nfunction load(req, res, next, userId) {\r\n    Client.get(userId)\r\n    .then((client) => {\r\n        req.client = client;\r\n        return next();\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Get client\r\n* @returns {Client}\r\n*/\r\nfunction get(req, res) {\r\n    return req.client;\r\n}\r\n\r\n/**\r\n* Get client's Appointments\r\n* @returns {Appointment[]}\r\n*/\r\nfunction getAppointments(req, res, next) {\r\n    return Appointment.find({client: req.client._id}) \r\n        .populate('client professional')\r\n        .sort('startDate')\r\n        .exec()\r\n        .then(appointments => appointments);\r\n}\r\n\r\n\r\n/**\r\n* Checks if user exists with same email as client.  If not, it creates a new User with the email provided and a default password. Then creates the Client to reside in the new user\r\n* @returns {Client}\r\n*/\r\nfunction create(req, res, next) {\r\n    return Client.exists(req.body.email).then(existingClient =>{\r\n        if(existingClient){\r\n            const err = new APIError('Error: Client Already Exists', httpStatus.FORBIDDEN, true);\r\n            return next(err);\r\n        }else{\r\n            let client = new Client(req.body);\r\n            client.status = 1;\r\n            return client.save().then(savedClient =>{\r\n                //check if user already exists\r\n                return User.getByEmail(req.body.email)\r\n                .then(existingUser=>{\r\n                    if(existingUser && existingUser.length > 0)\r\n                    {\r\n                        existingUser.client = savedClient._id;\r\n                        return existingUser.update().then(savedUser => {\r\n                            //return userid with professional\r\n                            let savedObj = savedClient.toObject();\r\n                            savedObj.userId = savedUser._id;\r\n                            return savedObj;\r\n                        });\r\n                    } else {\r\n                        //create new user.  Attach client\r\n                        return new User({\r\n                            role: Constants.roles.Client,\r\n                            email: req.body.email,\r\n                            password: Constants.defaultPassword,\r\n                            client: savedClient._id\r\n                        }).save().then(savedUser => {\r\n                            let savedObj = savedClient.toObject();\r\n                            savedObj.userId = savedUser._id;\r\n                            return savedObj;\r\n                        })\r\n                        .catch(e => next(e));\r\n                    }\r\n                })\r\n                .catch(e => next(e));\r\n            })\r\n            .catch(e => next(e));\r\n\r\n        }\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Update existing client\r\n* @property {string} req.body.email - The email of client.\r\n* @returns {Client}\r\n*/\r\nfunction update(req, res, next) {\r\n    let client = req.client;\r\n    for(let prop in req.body){\r\n        client[prop] = req.body[prop];\r\n    }\r\n    return client.save()\r\n    .then(savedClient => savedClient)\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Get client list.\r\n* @property {number} req.query.skip - Number of clients to be skipped.\r\n* @property {number} req.query.limit - Limit number of clients to be returned.\r\n* @returns {Client[]}\r\n*/\r\nfunction list(req, res, next) {\r\n    const { limit = 20, skip = 0 } = req.query;\r\n    delete req.query.limit;\r\n    delete req.query.skip;    \r\n    let queryObj = buildQuery(req);\r\n    \r\n    return Client.find(queryObj.length > 0 ? {$and: queryObj} : {})\r\n        .sort({ createdAt: -1 }) \r\n        .skip(skip)\r\n        .limit(limit)\r\n        .then(clients => clients)\r\n        .catch(e => next(e));\r\n}\r\n\r\nfunction buildQuery(req){\r\n    if (Object.keys(req.query).length === 0) return [];\r\n    var array = [];\r\n    for (var key in req.query) {\r\n        var obj = {};\r\n        obj[key] = req.query[key];\r\n        array.push(obj);\r\n    }\r\n    return array;\r\n}\r\n\r\n\r\n/**\r\n* Delete client.\r\n* @returns {Client}\r\n*/\r\nfunction remove(req, res, next) {\r\n    const client = req.client;\r\n    return client.remove()\r\n    .then(deletedClient => deletedClient)\r\n    .catch(e => next(e));\r\n}\r\n\r\nexport default { load, get, create, update, list, remove, getAppointments };\r\n"]}