{"version":3,"sources":["../../src/server/controllers/auth-controller.js"],"names":["login","req","res","next","body","email","password","err","UNAUTHORIZED","getByEmail","then","existingUser","comparePassword","error","pwdIsValid","authToken","createToken","json","catch","e","updatePassword","params","user","save","savedUser","forgotPassword","randomBytes","buffer","token","toString","resetPasswordToken","resetPasswordExpires","Date","now","context","url","domain","sendEmail","message","EXPECTATION_FAILED","verifyToken","env","get","unsignedToken","verify","jwtSecret","locals","sessionUserEmail","sign","person","professional","client","organization","_id","role","firstname","lastname","organizationId","getRandomNumber","num","Math","random"],"mappings":"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","file":"auth-controller.js","sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport httpStatus from 'http-status';\r\nimport { User } from '../models';\r\nimport APIError from '../lib/APIError';\r\nimport config from '../config';\r\nimport crypto from 'crypto';\r\nimport {EmailCtrl} from '../controllers';\r\n/**\r\n* Returns jwt token if valid username and password is provided\r\n* @param req\r\n* @param res\r\n* @param next\r\n* @returns {*} \r\n*/\r\nfunction login(req, res, next) {\r\n    if(!req.body.email || !req.body.password){\r\n        const err = new APIError('Authentication error: Email and password required', httpStatus.UNAUTHORIZED, true);\r\n        return next(err);\r\n    }\r\n    User.getByEmail(req.body.email, true)\r\n    .then(existingUser=>{\r\n        if(!existingUser){\r\n            const err = new APIError('Authentication error: Invalid Credentials', httpStatus.UNAUTHORIZED, true);\r\n            return next(err);\r\n        }\r\n        existingUser.comparePassword(req.body.password,function(error,pwdIsValid){\r\n            if(error){\r\n                const err = new APIError('Authentication error', httpStatus.UNAUTHORIZED, false);\r\n                return next(err);\r\n            }\r\n            if(!pwdIsValid){\r\n                const err = new APIError('Authentication error: Invalid Credentials ', httpStatus.UNAUTHORIZED, true);\r\n                return next(err);\r\n            }\r\n            let authToken  = createToken(existingUser);\r\n            return res.json(authToken);\r\n        })\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Update user password\r\n* @property {string} req.body.email - The email of user.\r\n* @returns {User}\r\n*/\r\n\r\nfunction updatePassword(req, res, next) {\r\n    return User.getByEmail(req.params.email, true)\r\n    .then((user) => {\r\n        user.password = req.body.password;\r\n        return user.save()\r\n        .then(savedUser => res.json(savedUser))\r\n        .catch(e => next(e));\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n/**\r\n* Send forgot password link if user exists.  Adds a password hash to the user and an expiration\r\n* @property {string} req.body.email - The email of user.\r\n* @returns {User}\r\n*/\r\n\r\nfunction forgotPassword(req, res, next) {\r\n    return User.getByEmail(req.body.email,false)\r\n    .then((user) => {\r\n        if(!user){\r\n            const err = new APIError('Authentication error: No user with that email exists', httpStatus.UNAUTHORIZED, true);\r\n            return next(err);    \r\n        }else{\r\n            return crypto.randomBytes(20, (err, buffer) => {\r\n                const token = buffer.toString('hex');\r\n                user.resetPasswordToken = token;\r\n                user.resetPasswordExpires = Date.now() + 86400000;\r\n                return user.save()\r\n                    .then(newUser => {\r\n                        //send email to user with link to change password\r\n                        const context = {\r\n                            url: `${config.domain}/forgot-password?email=${user.email}&token=${token}`\r\n                        };\r\n                        return EmailCtrl.sendEmail(user.email, 'forgot-password', 'Forgot Password help on the way!',context)\r\n                            .then(message => {\r\n                                return {message: 'The link with the password change has been sent to your email address.'}\r\n                            })\r\n                            .catch(e => {\r\n                                const err = new APIError(`Unable to send password link to email address: ${user.email}`, httpStatus.EXPECTATION_FAILED, true);\r\n                                return next(err);                    \r\n                            });\r\n                        })\r\n                .catch(e => next(e));\r\n            })    \r\n        }\r\n    })\r\n    .catch(e => next(e));\r\n}\r\n\r\n\r\n/**\r\n* Verifies Authorization token sent in API Request.  If valid, it returns the user email on the req.locals object.\r\n* If invalid, jwt throws an Authorization error\r\n* @param req\r\n* @param res\r\n* @returns {*}\r\n*/\r\nfunction verifyToken(req,res,next){\r\n    if(config.env === 'test')\r\n        return next();\r\n\r\n    var token = req.get('Authorization');\r\n    var unsignedToken = jwt.verify(token,config.jwtSecret);\r\n    req.locals = {\r\n        sessionUserEmail: unsignedToken.email,\r\n    };\r\n    next();\r\n}\r\n\r\n// creates the token from a user\r\nfunction createToken(user){\r\n    const token = jwt.sign({\r\n        email: user.email\r\n    }, config.jwtSecret);\r\n    var person = user.professional ? user.professional : user.client;\r\n    var organization = user.professional ? user.professional.organization : '';\r\n    return {\r\n        _id: person._id,\r\n        token,\r\n        email: user.email,\r\n        role: user.role,\r\n        firstname: user.professional ? user.professional.firstname : user.client.firstname,\r\n        lastname: user.professional ? user.professional.lastname : user.client.lastname,\r\n        organizationId: organization\r\n    };\r\n\r\n}\r\n\r\n/**\r\n* This is a protected route. Will return random number only if jwt token is provided in header.\r\n* @param req\r\n* @param res\r\n* @returns {*}\r\n*/\r\nfunction getRandomNumber(req, res) {\r\n    // req.user is assigned by jwt middleware if valid token is provided\r\n    return res.json({\r\n        user: req.user,\r\n        num: Math.random() * 100\r\n    });\r\n}\r\nexport default { login, getRandomNumber, verifyToken, updatePassword, createToken, forgotPassword };\r\n"]}